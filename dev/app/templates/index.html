<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertAutomator Dashboard</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body>
    <div class="app-wrapper">
        <!-- Sidebar Navigation -->
        <nav class="app-sidebar">
            <div class="sidebar-header">
                <div class="logo" style="display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="display: flex; align-items: center; justify-content: center; width: 54px; height: 54px; background: rgba(0, 240, 255, 0.08); border: 2px solid rgba(0, 240, 255, 0.4); border-radius: 8px; padding: 5px; box-shadow: 0 0 25px rgba(0, 240, 255, 0.35), inset 0 0 10px rgba(0, 240, 255, 0.15); flex-shrink: 0;">
                        <img src="/static/app_icon.png" alt="Logo"
                            style="width: 100%; height: 100%; border-radius: 4px;">
                    </div>
                    <div class="app-logo-text" style="font-size: 1.1rem; letter-spacing: 0.05em;">
                        Cert<span>Automator</span></div>
                </div>
            </div>

            <div class="nav-links">
                <a href="#" class="nav-item active">
                    <div class="nav-item-icon">
                        <svg viewBox="0 0 24 24">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </div>
                    <span>Dashboard</span>
                </a>
                <a href="javascript:void(0)"
                    onclick="document.getElementById('services-section').scrollIntoView({behavior: 'smooth'})"
                    class="nav-item">
                    <div class="nav-item-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                    </div>
                    <span>Services</span>
                </a>
                <a href="javascript:void(0)"
                    onclick="document.getElementById('logs-section').scrollIntoView({behavior: 'smooth'})"
                    class="nav-item">
                    <div class="nav-item-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M4 17l6-6-6-6M12 19h8"></path>
                        </svg>
                    </div>
                    <span>Logs</span>
                </a>
                <div style="flex:1"></div> <!- Spacer ->
                    <a href="javascript:void(0)" id="sidebar-settings-btn"
                        onclick="document.getElementById('settings-btn').click()" class="nav-item">
                        <div class="nav-item-icon">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                                </path>
                            </svg>
                        </div>
                        <span>Settings</span>
                    </a>
            </div>

            <div class="sidebar-footer">
                <p>&copy; 2026 Lokesh G.</p>
                <p style="opacity: 0.6; font-size: 0.75rem;">{{ app_version }}</p>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Top Controls (formerly Header) -->
            <header style="border-bottom: none; margin-bottom: 2rem;">
                <!-- Left Side: Hero Title or Breadcrumb -->
                <div>
                    <h1 style="font-size: 1.75rem; font-weight: 700;">Dashboard</h1>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Overview</p>
                </div>

                <!-- Right Side: Controls -->
                <div class="header-controls">
                    <!-- Hidden Trigger for JS compatibility if needed, or mapped -->
                    <button id="settings-btn" class="btn btn-secondary" title="Settings"
                        style="display:none;">Settings</button>

                    <button id="view-cert-btn" class="btn btn-secondary">
                        View Default Certificate
                    </button>
                    <div id="cert-status" class="status-tag pending">
                        Checking...
                    </div>
                </div>
            </header>

            <!-- Hero Stats / Upload Section -->
            <section class="upload-section cyber-panel"
                style="text-align: left; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-glass); padding-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.25rem; color: var(--accent-primary);">
                            Default Certificate</h2>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">
                            ROOT_AUTHORITY // WILDCARD_BUNDLE</p>
                    </div>
                    <button id="upload-btn" class="btn btn-primary">
                        INITIALIZE_UPLOAD
                    </button>
                </div>

                <div class="upload-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">

                    <div class="upload-card data-plate">
                        <label
                            style="font-size: 0.75rem; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; font-weight: 700;">Certificate
                            [.crt]</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="file-cert" accept=".pem,.crt" class="cyber-file-input"
                                onchange="updateFileName(this, 'display-cert')">
                            <label for="file-cert" class="cyber-file-label">SELECT FILE</label>
                            <span id="display-cert" class="file-name-display">NO_FILE_CHOSEN</span>
                        </div>
                    </div>

                    <div class="upload-card data-plate">
                        <label
                            style="font-size: 0.75rem; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; font-weight: 700;">Private
                            Key [.key]</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="file-key" accept=".pem,.key" class="cyber-file-input"
                                onchange="updateFileName(this, 'display-key')">
                            <label for="file-key" class="cyber-file-label">SELECT FILE</label>
                            <span id="display-key" class="file-name-display">NO_FILE_CHOSEN</span>
                        </div>
                    </div>

                    <div class="upload-card data-plate">
                        <label
                            style="font-size: 0.75rem; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; font-weight: 700;">Intermediate</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="file-inter" accept=".pem,.crt" class="cyber-file-input"
                                onchange="updateFileName(this, 'display-inter')">
                            <label for="file-inter" class="cyber-file-label">SELECT FILE</label>
                            <span id="display-inter" class="file-name-display">NO_FILE_CHOSEN</span>
                        </div>
                    </div>

                    <div class="upload-card data-plate">
                        <label
                            style="font-size: 0.75rem; color: var(--accent-primary); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem; display: block; font-weight: 700;">Root
                            CA</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="file-root" accept=".pem,.crt" class="cyber-file-input"
                                onchange="updateFileName(this, 'display-root')">
                            <label for="file-root" class="cyber-file-label">SELECT FILE</label>
                            <span id="display-root" class="file-name-display">NO_FILE_CHOSEN</span>
                        </div>
                    </div>
                </div>
                <div id="upload-status" style="font-family: var(--font-primary); font-size: 0.8rem;"></div>
            </section>

            <!-- Services Section -->
            <section id="services-section" style="margin-top: 3rem;">
                <div class="section-header">
                    <div>
                        <h2>Services</h2>
                    </div>
                    <div class="actions" style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-secondary" onclick="triggerHealthCheck()">Check Health</button>
                        <button class="btn btn-secondary" onclick="openCertManager()">Manage Packs</button>
                        <button id="manage-services-btn" class="btn btn-secondary">Manage Services</button>
                        <button id="renew-all-btn" class="btn btn-primary">
                            Renew All
                        </button>
                    </div>
                </div>
                <div id="services-grid" class="services-grid">
                    <div class="loading-spinner" style="color: var(--text-secondary);">Loading Vault Data...</div>
                </div>
            </section>

            <!-- Logs Section -->
            <section id="logs-section" class="logs-container" style="margin-top: 3rem;">
                <div class="section-header">
                    <h2 style="margin: 0; font-size: 1.1rem;">System Logs</h2>
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <label class="toggle-switch"
                            style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <span
                                style="font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;">LIVE
                                REFRESH</span>
                            <input type="checkbox" id="auto-refresh-toggle" checked style="width: auto;"
                                onchange="if(this.checked) fetchLogs()">
                        </label>
                        <button id="autoscroll-btn" class="btn btn-secondary"
                            style="padding: 0.35rem 0.75rem; font-size: 0.75rem;">SCROLL: ON</button>
                    </div>
                </div>
                <div class="log-console" id="log-console"></div>
            </section>
        </main>
    </div>

    <!-- Service Editor Modal (Drawer) -->
    <div id="service-modal" class="modal-overlay hidden">
        <div class="modal-drawer">
            <div class="modal-header">
                <h3 id="service-modal-title">Manage Services</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="service-modal-body">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer" id="service-modal-footer">
                <button class="btn btn-secondary close-modal-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Generic Details/Manager Modal -->
    <div id="details-modal" class="modal-overlay hidden">
        <div class="modal-drawer">
            <div class="modal-header">
                <h3 id="details-modal-title">Details</h3>
                <span id="close-details-modal" class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="details-modal-body">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer">
                <button id="close-details-btn" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <div id="cert-modal" class="modal-overlay hidden">
        <div class="modal-drawer">
            <div class="modal-header">
                <h3>Certificate Details</h3>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body" id="cert-details-body">
                <!-- Details injected here -->
            </div>
            <div class="log-console" id="modal-log-console"
                style="margin: 1.5rem; height: 200px; border-radius: 0.5rem;">
                <!-- Logs will appear here -->
                <span style="color: var(--text-secondary);">Loading logs...</span>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-drawer" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Settings</h3>
                <span class="close-modal-settings">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4
                        style="margin-bottom: 0.5rem; border-bottom: 1px solid var(--card-border); padding-bottom: 0.5rem;">
                        Change Master Password</h4>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="password" id="current-pass" placeholder="Current Password"
                            style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: white; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="password" id="new-pass" placeholder="New Password"
                            style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: white; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <input type="password" id="confirm-pass" placeholder="Confirm New Password"
                            style="width: 100%; padding: 0.5rem; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); color: white; border-radius: 4px;">
                    </div>
                    <button id="change-pass-btn" class="btn btn-primary" style="width: 100%;">Update Password</button>
                </div>
                <div
                    style="text-align: center; margin-top: 2rem; border-top: 1px solid var(--card-border); padding-top: 1rem;">
                    <button id="logout-btn" class="btn btn-secondary"
                        style="color: var(--error-color); border-color: var(--error-color);">Log Out</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal-settings-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Action Modal (Vanilla) -->
    <div id="action-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="action-modal-title">Action Required</h3>
                <span class="close-modal-action">&times;</span>
            </div>
            <div class="modal-body" id="action-modal-body">
                <!-- Content injected by JS -->
            </div>
            <div class="modal-footer" id="action-modal-footer">
                <button class="secondary-btn close-modal-action-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal (High Z-Index) -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px; border-color: var(--status-error);">
            <div class="modal-header">
                <h3 id="confirm-modal-title" style="color: var(--status-error);">Confirm Action</h3>
            </div>
            <div class="modal-body" id="confirm-modal-body"
                style="padding: 1.5rem; text-align: center; font-size: 1rem;">
                <!-- Content -->
            </div>
            <div class="modal-footer" id="confirm-modal-footer"
                style="justify-content: center; gap: 1rem; padding-bottom: 1.5rem;">
                <!-- Buttons -->
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        const API_BASE = '/api';

        // Secure fetch with CSRF protection
        async function secureFetch(url, options = {}) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const headers = {
                ...options.headers,
                'X-CSRF-Token': csrfToken
            };
            // Only add JSON content-type if we have a body and it's not FormData
            if (options.body && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            return fetch(url, { ...options, headers });
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');

            // De-duplication: Check if message already exists
            const existing = Array.from(container.children).find(t => t.innerText === message);
            if (existing) {
                // Reset timer/animation? Or just ignore.
                // Let's flash it to show it happened again.
                existing.style.transform = "scale(1.05)";
                setTimeout(() => existing.style.transform = "scale(1)", 100);
                return;
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;

            // Click to dismiss
            toast.onclick = () => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 200);
            };

            container.appendChild(toast);

            // Remove after duration
            setTimeout(() => {
                if (toast.parentElement) { // Check if not already removed
                    toast.style.animation = 'fadeOut 0.5s forwards';
                    toast.addEventListener('animationend', () => toast.remove());
                }
            }, duration);
        }


        // Action Modal Helpers
        const actionModal = document.getElementById('action-modal');
        const actionBody = document.getElementById('action-modal-body');
        const actionTitle = document.getElementById('action-modal-title');
        const actionFooter = document.getElementById('action-modal-footer');

        function hideActionModal() {
            actionModal.classList.add('hidden');
        }

        // Global Close handlers for Action Modal
        document.querySelectorAll('.close-modal-action, .close-modal-action-btn').forEach(el => {
            el.onclick = hideActionModal;
        });

        // Async Confirm Modal
        function showConfirm(title, message, confirmText = "Confirm", cancelText = "Cancel") {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const mTitle = document.getElementById('confirm-modal-title');
                const mBody = document.getElementById('confirm-modal-body');
                const mFooter = document.getElementById('confirm-modal-footer');

                mTitle.innerText = title;
                mBody.innerText = message;
                mFooter.innerHTML = '';

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.innerText = cancelText;
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(false);
                };

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary';
                confirmBtn.innerText = confirmText;
                confirmBtn.style.background = 'var(--status-error)';
                confirmBtn.style.color = 'black';

                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(true);
                };

                mFooter.appendChild(cancelBtn);
                mFooter.appendChild(confirmBtn);

                modal.classList.remove('hidden');
            });
        }

        // Elements
        const servicesGrid = document.getElementById('services-grid');
        const certStatus = document.getElementById('cert-status');
        const viewCertBtn = document.getElementById('view-cert-btn');
        const manageServicesBtn = document.getElementById('manage-services-btn');
        const logConsole = document.getElementById('log-console');
        const renewAllBtn = document.getElementById('renew-all-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadStatus = document.getElementById('upload-status');
        const autoScrollBtn = document.getElementById('autoscroll-btn');

        // Modal Elements
        const modal = document.getElementById('cert-modal');
        const modalBody = document.getElementById('cert-details-body');
        const closeSpans = document.querySelectorAll('.close-modal, .close-modal-btn');

        const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        let autoScroll = true;

        // Init
        async function init() {
            await fetchStatus();
            await fetchLogs();
            setInterval(fetchLogs, 3000);

            // Auto-Scroll Toggle Logic
            if (autoScrollBtn) {
                autoScrollBtn.onclick = () => {
                    autoScroll = !autoScroll;
                    autoScrollBtn.innerText = autoScroll ? "SCROLL: ON" : "SCROLL: OFF";
                    autoScrollBtn.style.borderColor = autoScroll ? "var(--border-glass)" : "var(--status-warning)";
                    autoScrollBtn.style.color = autoScroll ? "var(--accent-primary)" : "var(--status-warning)";
                };
            }
        }

        async function fetchStatus() {
            try {
                const res = await secureFetch(`${API_BASE}/status`);
                if (res.status === 401) {
                    certStatus.textContent = "System Locked";
                    certStatus.className = "status-tag pending";
                    return;
                }
                const data = await res.json();
                if (data.locked) {
                    certStatus.textContent = "System Locked";
                    certStatus.className = "status-tag pending";
                    return;
                }
                updateCertStatus(data);
                renderServices(data.services);
            } catch (e) {
                console.error(e);
            }
        }

        function updateCertStatus(data) {
            if (data.cert_details) {
                const cd = data.cert_details;
                if (!cd.default_exists) {
                    certStatus.textContent = "Certificate Not Ready";
                    certStatus.className = "status-tag error";
                } else if (cd.expired_packs > 0) {
                    if (cd.expired_packs === cd.total_packs) {
                        certStatus.textContent = "All Packs Expired";
                        certStatus.className = "status-tag error";
                    } else {
                        certStatus.textContent = `${cd.expired_packs} Packs Expired`;
                        certStatus.className = "status-tag warning";
                    }
                } else {
                    certStatus.textContent = "Certificates Ready";
                    certStatus.className = "status-tag success";
                }
            } else {
                // Fallback for transition
                if (data.certs_ready) {
                    certStatus.textContent = "Certificates Ready";
                    certStatus.className = "status-tag success";
                } else {
                    certStatus.textContent = "Certificates Missing";
                    certStatus.className = "status-tag error";
                }
            }
        }

        function renderServices(servicesList) {
            currentServices = servicesList; // Store for global access
            const container = document.getElementById('services-grid');
            if (!container) return;

            if (servicesList.length === 0) {
                container.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-secondary);">No services configured. Click "Manage Services" to add one.</div>';
                return;
            }

            let tableHtml = `
            <div class="services-table-wrapper" style="overflow-x:auto;">
                <table class="services-table" style="width:100%; border-collapse: separate; border-spacing: 0 0.5rem;">
                    <colgroup>
                        <col style="width: 20%;">
                        <col style="width: 20%;">
                        <col style="width: 10%;">
                        <col style="width: 20%;">
                        <col style="width: 15%;">
                        <col style="width: 180px;"> <!-- Fixed Actions Width -->
                    </colgroup>
                    <thead>
                        <tr style="color: var(--text-secondary); font-family: var(--font-primary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; text-align: left;">
                            <th style="padding: 1rem;">Service Name</th>
                            <th style="padding: 1rem;">Host / IP</th>
                            <th style="padding: 1rem;">Type</th>
                            <th style="padding: 1rem;">Health</th>
                            <th style="padding: 1rem;">Renewal</th>
                            <th style="padding: 1rem; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            servicesList.forEach(svc => {
                // Last Renewal Logic
                let renewalHtml = '<span style="color:var(--text-secondary); font-size: 0.75rem; opacity: 0.7; font-family: var(--font-primary);">&lt;NULL&gt;</span>';
                if (svc.last_renewal && svc.last_renewal.last_run) {
                    const s = svc.last_renewal;
                    const statusClass = s.status === 'Success' ? 'success' : 'error';
                    const icon = s.status === 'Success' ? 'OK' : 'ERR';
                    const time = timeAgo(s.last_run);
                    const msg = s.message || s.status;
                    renewalHtml = `<span class="status-tag ${statusClass}" title="${msg}" style="cursor:help;">
                        <span style="opacity:0.7">${icon}</span> ${time}
                    </span>`;
                }

                // ... (Health Logic same but wrapped) ...
                let healthHtml = `<span id="status-${svc.name}" class="status-tag pending">PENDING</span>`;

                // Simplified Health for table compactness:
                // We'll just show markers for Local/Remote
                let localStatus = svc.health_status && svc.health_status.valid ? 'success' : 'error';
                let remoteStatus = svc.ssl_status && svc.ssl_status.valid ? 'success' : 'error';

                // Detailed breakdown
                healthHtml = `
                    <div style="display: flex; gap: 0.5rem;">
                        <span class="status-tag ${localStatus}" title="Local Pack">L</span>
                        <span class="status-tag ${remoteStatus}" title="Remote SSL">R</span>
                    </div>
                `;
                // If we want the full detail we can keep it, but compact is better for "Cyber" tables.
                // Let's stick to the previous detailed view but styled better.

                let localHealthHtml = `<span class="status-tag pending">?</span>`;
                if (svc.health_status) {
                    const h = svc.health_status;
                    let c = !h.valid ? 'error' : (h.days_remaining <= 30 ? 'pending' : 'success');
                    localHealthHtml = `<span class="status-tag ${c}" title="Local: ${h.message}">LOC:${h.status}</span>`;
                }

                let remoteHealthHtml = `<span class="status-tag pending">?</span>`;
                if (svc.ssl_status) {
                    const s = svc.ssl_status;
                    let c = !s.valid ? 'error' : (s.days_remaining <= 30 ? 'pending' : 'success');
                    remoteHealthHtml = `<span class="status-tag ${c}" title="Remote: ${s.days_remaining}d">REM:${s.days_remaining}d</span>`;
                }

                healthHtml = `
                    <div style="display: flex; flex-direction: column; gap: 4px; font-size: 0.7rem;">
                        ${localHealthHtml}
                        ${remoteHealthHtml}
                    </div>
                `;


                tableHtml += `
                    <tr data-service="${svc.name}" class="cyber-row" style="background: rgba(255,255,255,0.02); transition: background 0.2s;">
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass);">
                            <div style="font-family: var(--font-primary); font-weight: 700; color: var(--text-primary); letter-spacing: 0.05em;">${svc.name}</div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass);">
                            <div style="font-family: var(--font-primary); color: var(--accent-primary); font-size: 0.85rem;">${svc.host || '<span style="opacity:0.3">--</span>'}</div>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass);">
                            <span style="font-family: var(--font-primary); font-size:0.75rem; border: 1px solid var(--border-glass); padding: 2px 6px; text-transform: uppercase;">${svc.type || 'UNK'}</span>
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass);">
                            ${healthHtml}
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass);">
                            ${renewalHtml}
                        </td>
                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-glass); text-align:right;">
                            <div style="display:flex; gap: 8px; justify-content: flex-end; align-items: center;">
                                <button class="cyber-icon-btn renew" title="Renew" onclick="renewService('${svc.name}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.39 0 4.57.94 6.19 2.47L21 6"/>
                                        <path d="M21 1v5h-5"/>
                                        <path d="M12 7v5l2 2"/>
                                    </svg>
                                </button>
                                <button class="cyber-icon-btn check" id="check-btn-${svc.name}" title="Check" onclick="checkService('${svc.name}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
                                        <circle cx="12" cy="12" r="3" stroke-dasharray="2 3"/>
                                        <path d="M12 9v6M9 12h6" stroke-opacity="0.4"/>
                                    </svg>
                                </button>
                                <button class="cyber-icon-btn edit" title="Edit" onclick="openServiceEditorModal('${svc.name}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M4 21v-7m0-4V3m8 18v-9m0-4V3m8 18v-5m0-4V3M1 14h6m2-6h6m2 8h6"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            container.innerHTML = tableHtml;
        }

        async function triggerHealthCheck() {
            showToast("Running Health Check...", "info");
            try {
                const res = await secureFetch(`${API_BASE}/health-check`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    showToast("Health Check Complete", "success");
                    fetchStatus(); // Refresh UI
                } else {
                    showToast("Health Check Failed: " + data.message, "error");
                }
            } catch (e) {
                showToast("Error: " + e, "error");
            }
        }

        async function checkService(name) {
            const btn = document.getElementById(`check-btn-${name}`);
            if (btn) {
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '...';
            }
            showToast(`Checking ${name}...`); // Info toast
            try {
                const res = await secureFetch(`${API_BASE}/check/${name}`, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    showToast(`Check successful: Valid for ${data.days_remaining} days`, "success");
                    fetchStatus(); // Refresh list to show new status
                } else {
                    showToast(`Check failed: ${data.message}`, "error");
                }
            } catch (e) {
                showToast("Check failed: Network error", "error");
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'ðŸ”';
                }
            }
        }

        async function renewService(name) {
            const statusEl = document.getElementById(`status-${name}`);
            const row = document.querySelector(`tr[data-service="${name}"]`); // If in list view

            // Assuming this function is called from the card view primarily
            // Use the global 'currentServices' (from loadStatus mostly, or fetch fresh)
            // Ideally we pass the full service object or find it.
            // Let's find the service object from the DOM or global state if possible.
            // Since init calls fetchStatus -> renderServices, 'currentServices' might not be populated if we didn't open the modal.
            // But we can find host from the DOM or just fetch it.
            // For the modal message, we need the host. 
            // Let's assume we can get it from the card or just use 'OPNsense Firewall'.

            statusEl.textContent = "Renewing...";
            statusEl.className = "status-text processing";

            try {
                const req = await secureFetch(`${API_BASE}/renew/${name}`, { method: 'POST' });
                const res = await req.json();

                statusEl.textContent = res.success ? "Success" : "Failed";
                statusEl.className = res.success ? "status-text success" : "status-text error";

                // Handle Rich Response (Global)
                if (res.success && res.manual_activation) {
                    // Try to find host for the link
                    let host = "your OPNsense firewall";
                    // Try to finding it in the card text content as a fallback or fetching status again is overkill.
                    // Let's just give a generic message if we can't find it, or use the UUID.

                    let body = `<p><strong>Certificate Uploaded Successfully!</strong></p>
                                <div class="alert alert-warning">
                                    <strong>Action Required:</strong> Log in to OPNsense
                                    and go to <code>System > Settings > Administration</code>.
                                    <br>Select the new certificate (UUID: <code>${res.uuid || 'new'}</code>) and Save.
                                </div>`;

                    let buttons = "";
                    if (res.expired_count > 0) {
                        body += `<hr><p class="text-danger">Found ${res.expired_count} expired 'AutoRenew' certificates.</p>`;
                        buttons = `<button class="btn btn-danger" onclick="cleanupService('${name}')">Delete Expired Certs</button>`;
                    }

                    showActionModal("Manual Activation Required", body, buttons);
                } else if (!res.success) {
                    showToast("Renew Failed: " + res.message, "error");
                } else {
                    // Standard success
                    showToast("Renewal Successful", "success");
                    // Refresh status to show new expiry
                    fetchStatus();
                }
            } catch (e) {
                statusEl.textContent = "Error";
                statusEl.className = "status-text error";
                showToast("Connection Error Details: " + e, "error");
                console.error(e);
            }
        }

        renewAllBtn.onclick = async () => {
            renewAllBtn.disabled = true;
            renewAllBtn.innerHTML = "Renewing...";
            try {
                await secureFetch(`${API_BASE}/renew/all`, { method: 'POST' });
                showToast("Renew All Sequence Completed", "success");
                await fetchStatus(); // Immediate Refresh
            } catch (e) {
                console.error(e);
                showToast("Renewal Error: " + e, "error");
            } finally {
                renewAllBtn.disabled = false;
                renewAllBtn.innerHTML = '<span class="icon">âš¡</span> Renew All';
            }
        };

        async function fetchLogs() {
            // Check Auto-Refresh
            if (autoRefreshToggle && !autoRefreshToggle.checked) return;

            try {
                const res = await secureFetch(`${API_BASE}/logs`);
                const data = await res.json();

                const newLines = data.logs;
                const newContent = newLines.map(line => `<div class="log-line">${line}</div>`).join('');
                if (logConsole.innerHTML === newContent) return;

                // --- STICKY SCROLL ANCHOR LOGIC ---
                // If autoscroll is OFF, we find the first visible line and use it as an anchor
                let anchorText = null;
                let anchorTopOffset = 0;
                const wasAtBottom = Math.abs(logConsole.scrollHeight - logConsole.clientHeight - logConsole.scrollTop) < 30;

                if (!autoScroll && !wasAtBottom) {
                    const lines = logConsole.querySelectorAll('.log-line');
                    for (let line of lines) {
                        const rec = line.getBoundingClientRect();
                        const containerRec = logConsole.getBoundingClientRect();
                        if (rec.top >= containerRec.top) {
                            anchorText = line.textContent;
                            anchorTopOffset = rec.top - containerRec.top;
                            break;
                        }
                    }
                }

                logConsole.innerHTML = newContent;

                if (autoScroll || wasAtBottom) {
                    logConsole.scrollTop = logConsole.scrollHeight;
                } else if (anchorText) {
                    // Find the anchor in the new content
                    const newLinesElements = logConsole.querySelectorAll('.log-line');
                    for (let line of newLinesElements) {
                        if (line.textContent === anchorText) {
                            const containerRec = logConsole.getBoundingClientRect();
                            const newLineTop = line.offsetTop - logConsole.offsetTop;
                            // Set scrollTop so the line is back at the same relative position
                            logConsole.scrollTop = newLineTop - anchorTopOffset;
                            break;
                        }
                    }
                }
            } catch (e) { }
        }

        // Service Management Logic
        const serviceModal = document.getElementById('service-modal');
        let currentServices = [];
        let serviceTypesMap = {};
        let availableBaseHandlers = [];

        async function fetchTypes() {
            try {
                const res = await secureFetch(`${API_BASE}/types`);
                const data = await res.json();
                if (data.success) {
                    serviceTypesMap = data.types;
                    availableBaseHandlers = data.base_handlers;
                }
            } catch (e) { console.error("Failed to fetch types", e); }
        }

        async function populateTypeSelect(selectedAlias = null) {
            const select = document.getElementById('svc-type');
            if (!select) return;
            select.innerHTML = '';

            // Sort keys alpa-betically
            const aliases = Object.keys(serviceTypesMap).sort();

            aliases.forEach(alias => {
                const base = serviceTypesMap[alias];
                const option = document.createElement('option');
                option.value = alias;
                option.textContent = alias === base ? `${alias.charAt(0).toUpperCase() + alias.slice(1)}` : `${alias} (${base})`;

                // Specific labels for known types if unmodified?
                if (alias === 'linux' && alias === base) option.textContent = "Generic Linux (SSH)";

                if (selectedAlias === alias) option.selected = true;
                select.appendChild(option);
            });
        }

        function renderTypesManager() {
            const modalBody = document.getElementById('action-modal-body');
            const modalTitle = document.getElementById('action-modal-title');
            const modalFooter = document.getElementById('action-modal-footer');

            modalTitle.innerText = "Manage Service Types";
            modalFooter.innerHTML = '<button class="btn btn-secondary" onclick="hideActionModal()">Close</button>';

            let html = `
                <div class="cyber-panel" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                    <h4 style="margin-top:0; margin-bottom: 1rem; color: var(--text-primary);">Add New Type / Context</h4>
                    <div style="display: flex; gap: 0.75rem;">
                        <input type="text" id="new-type-name" placeholder="Name (e.g. 'Nginx', 'My Router')" style="flex:1;">
                        <select id="new-type-base" style="width: auto;">
                             ${availableBaseHandlers.map(h => `<option value="${h}">${h}</option>`).join('')}
                        </select>
                        <button id="add-type-btn" class="btn btn-secondary" style="border-color: var(--status-success); color: var(--status-success);">Add</button>
                    </div>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align:left; color:var(--text-secondary); border-bottom: 1px solid var(--border-glass);">
                                <th style="padding:0.75rem;">Name</th>
                                <th style="padding:0.75rem;">Base Handler</th>
                                <th style="padding:0.75rem;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(serviceTypesMap).map(([name, base]) => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                                    <td style="padding:0.75rem; color: var(--text-primary); font-weight: 500;">${name}</td>
                                    <td style="padding:0.75rem;"><span class="service-badge">${base}</span></td>
                                    <td style="padding:0.75rem; text-align:right;">
                                        <button class="btn btn-secondary" style="padding:0.3rem 0.6rem; font-size: 0.8rem; color: var(--status-error); border-color: var(--status-error);" onclick="deleteType('${name}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('action-modal').classList.remove('hidden');

            // Bind Add
            document.getElementById('add-type-btn').onclick = async () => {
                const name = document.getElementById('new-type-name').value;
                const baseHandler = document.getElementById('new-type-base').value;
                if (!name) return showToast("Name required", "error");

                try {
                    const req = await secureFetch(`${API_BASE}/types`, {
                        method: 'POST',
                        body: JSON.stringify({ name, base_handler: baseHandler })
                    });
                    const res = await req.json();
                    if (res.success) {
                        showToast("Type added", "success");
                        await fetchTypes();
                        renderTypesManager(); // Redraw
                        // Refresh main form dropdown if open? 
                        populateTypeSelect(document.getElementById('svc-type') ? document.getElementById('svc-type').value : null);
                    } else {
                        showToast(res.message, "error");
                    }
                } catch (e) { showToast(e, "error"); }
            };

            // Bind Delete Globals
            window.deleteType = async (name) => {
                if (!await showConfirm("Delete Service Type", `Are you sure you want to delete '${name}'?`, "Delete")) return;
                try {
                    const req = await secureFetch(`${API_BASE}/types`, {
                        method: 'DELETE',
                        body: JSON.stringify({ name })
                    });
                    const res = await req.json();
                    if (res.success) {
                        showToast("Type deleted", "success");
                        await fetchTypes();
                        renderTypesManager();
                        populateTypeSelect();
                    } else {
                        showToast(res.message, "error");
                    }
                } catch (e) { showToast(e, "error"); }
            };
        }

        function timeAgo(dateString) {
            if (!dateString || dateString === 'None') return 'Never';

            let date = new Date(dateString);

            // If invalid, try appending Z (assuming it was naive UTC)
            if (isNaN(date.getTime())) {
                date = new Date(dateString + "Z");
            }

            // Still invalid?
            if (isNaN(date.getTime())) return 'Never'; // Fallback



            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            // Future date check
            if (seconds < 0) return "Just now";

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        }

        function renderServiceList(services) {
            let html = '<div style="margin-bottom: 1.5rem;"><button id="add-service-btn" class="btn btn-secondary" style="width:100%">+ Add New Service</button></div>';

            // Grid container (already defined in HTML as services-grid, but we are injecting innerHTML)
            // Wait, services-grid is the container. This function returns children.
            // But previous code started with <div style="max-height..."> which suggests it was a list VIEW inside the modal?
            // checking callers:
            // manageServicesBtn.onclick -> modalBody.innerHTML = renderServiceList(currentServices);
            // So this IS only for the Modal Manager List, not the main Dashboard Grid.
            // The main dashboard grid is likely rendered by something else ("fetchStatus" I recall).

            // Let's style this list for the Drawer.
            html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

            if (!services || services.length === 0) {
                html += '<div style="padding:1rem; text-align:center; color:var(--text-secondary);">No services configured.</div>';
            } else {
                services.forEach(svc => {
                    let statusHtml = '<span class="status-tag" style="opacity:0.7;">Never</span>';

                    if (svc.last_renewal && svc.last_renewal.last_run) {
                        const s = svc.last_renewal;
                        const statusClass = s.status === 'Success' ? 'success' : 'error';
                        const icon = s.status === 'Success' ? 'âœ…' : 'âŒ';
                        const time = timeAgo(s.last_run);
                        statusHtml = `<span class="status-tag ${statusClass}" title="${s.message || s.status}">
                            ${icon} ${time}
                        </span>`;
                    }

                    html += `
                        <div class="cyber-panel" style="padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-radius: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 1rem;">${svc.name}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    <span class="service-badge" style="font-size: 0.7rem;">${svc.type || 'UNKNOWN'}</span> 
                                    <span style="opacity: 0.7;">@ ${svc.host || 'N/A'}</span>
                                </div>
                            </div>
                            
                             <div style="text-align: right; margin-right: 1rem;">
                                ${statusHtml}
                            </div>

                            <button class="btn btn-secondary edit-svc-btn" data-name="${svc.name}" style="padding: 0.4rem 0.8rem;">Edit</button>
                        </div>
                    `;
                });
            }
            html += '</div>';
            return html;
        }

        function renderServiceForm(service = null) {
            const isEdit = !!service;
            const title = isEdit ? `Edit ${service.name}` : 'Add New Service';

            // Common fields
            const name = service ? service.name : '';
            const host = service ? service.host || '' : '';
            // Default type: 'proxmox' if exists, else first available
            const type = service ? service.type || 'proxmox' : 'proxmox';

            let html = `
                <form id="svc-form" onsubmit="event.preventDefault();">
                <div class="data-plate" style="margin-bottom: 1rem;">
                    <label>Service Name *</label>
                    <input type="text" id="svc-name" value="${name}" placeholder="e.g., my-proxmox">
                </div>
                <div class="data-plate" style="margin-bottom: 1rem;">
                    <label>Host / IP *</label>
                    <input type="text" id="svc-host" value="${host}" placeholder="192.168.1.10">
                </div>
                <div class="data-plate" style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase;">Type *</label>
                    <div style="display:flex; gap:0.5rem; align-items: stretch;">
                         <select id="svc-type" style="flex:1;">
                            <!-- Populated Dynamically -->
                         </select>
                         <button id="manage-types-btn" class="cyber-icon-btn settings" style="height: auto; min-width: 38px;" title="Manage Service Types" onclick="renderTypesManager()">
                            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"></path></svg>
                         </button>
                    </div>
                </div>

                <div class="data-plate" style="margin-bottom: 1rem;">
                    <label>Certificate Source</label>
                    <select id="config-cert-pack">
                        <option value="default">Default (Root)</option>
                        <!-- Populated Dynamically -->
                    </select>
                </div>

                <!-- Webhook Section -->
                <div id="section-webhook" class="cyber-panel" style="display:none; margin-top: 1rem; padding: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--accent-primary);">Webhook Configuration</h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display:block; margin-bottom: 0.25rem;">Target URL</label>
                        <input type="text" id="webhook-url" class="form-input" placeholder="https://api.example.com/v1/certs" value="${service ? (service.url || '') : ''}">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display:block; margin-bottom: 0.25rem;">Method</label>
                        <select id="webhook-method" class="form-input">
                            <option value="POST" ${service && service.method === 'POST' ? 'selected' : ''}>POST</option>
                            <option value="PUT" ${service && service.method === 'PUT' ? 'selected' : ''}>PUT</option>
                            <option value="PATCH" ${service && service.method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:block; margin-bottom: 0.25rem;">Headers (JSON)</label>
                        <textarea id="webhook-headers" rows="3" class="form-input" style="font-family: var(--font-mono);" placeholder='{"Authorization": "Bearer token"}' spellcheck="false">${service ? (typeof service.headers === 'object' ? JSON.stringify(service.headers, null, 2) : (service.headers || '{}')) : '{}'}</textarea>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display:block; margin-bottom: 0.25rem;">Body Template (JSON/Text)</label>
                        <textarea id="webhook-body" rows="6" class="form-input" style="font-family: var(--font-mono);" placeholder='{
  "certificate": "{CERT}",
  "private_key": "{KEY}",
  "chain": "{CHAIN}"
}' spellcheck="false">${service ? (service.body_template || '') : ''}</textarea>
                        <small class="hint" style="display:block; margin-top:0.25rem; color: var(--text-secondary);">Use <code>{CERT}</code>, <code>{KEY}</code>, <code>{CHAIN}</code> as placeholders.</small>
                    </div>
                </div>

                <!-- SSH Section -->
                <div id="section-linux" class="cyber-panel dynamic-section" style="display: none; margin-bottom: 1rem; padding: 1.5rem;">
                    <div style="font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); display:flex; justify-content:space-between; align-items:center;">
                        SSH Configuration
                        <button id="ssh-detect-btn" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;">âœ¨ Auto-Detect (Docker)</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem; display:block;">Username</label>
                            <input type="text" id="ssh-user" value="${service ? service.user || 'root' : 'root'}">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem; display:block;">Password (or key path)</label>
                            <input type="password" id="ssh-pass" value="${service ? service.password || '' : ''}">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem; display:block;" id="lbl-ssh-cert">Remote Cert Path</label>
                        <input type="text" id="ssh-cert-path" value="${service ? service.remote_cert_path || '/etc/ssl/certs/fullchain.pem' : '/etc/ssl/certs/fullchain.pem'}">
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem; display:block;">Remote Key Path</label>
                        <input type="text" id="ssh-key-path" value="${service ? service.remote_key_path || '/etc/ssl/private/privkey.pem' : '/etc/ssl/private/privkey.pem'}">
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem; display:block;">Restart Command</label>
                        <input type="text" id="ssh-cmd" value="${service ? service.restart_cmd || 'systemctl reload nginx' : 'systemctl reload nginx'}">
                    </div>
                </div>

                <!-- Provisioning Section -->
                <div id="section-provision" class="dynamic-section" style="display: none; margin-bottom: 1rem; border: 1px dashed var(--border-glass); padding: 1.5rem; border-radius: 0.5rem;">
                    <div style="font-size: 0.95rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">Auto-Provision Credentials</div>
                    <div style="display: flex; gap: 0.75rem;">
                        <input type="text" id="prov-user" placeholder="Username (e.g. root)" style="flex:1;">
                        <input type="password" id="prov-pass" placeholder="Password" style="flex:1;">
                        <button id="prov-btn" class="btn btn-secondary">Fetch & Fill</button>
                    </div>
                    <div id="prov-status" style="margin-top: 0.75rem; font-size: 0.85rem;"></div>
                </div>

                <!-- OPNsense Manual Guide -->
                <div id="section-opnsense-guide" class="dynamic-section" style="display: none; margin-bottom: 1rem; border: 1px solid var(--accent-primary); padding: 1rem; border-radius: 0.5rem; background: rgba(45, 212, 191, 0.05);">
                    <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">â„¹ï¸ How to get API Credentials</div>
                    <ol style="font-size: 0.85rem; margin-left: 1.5rem; color: var(--text-secondary); line-height: 1.5;">
                        <li>Log in to your <strong>OPNsense WebGUI</strong>.</li>
                        <li>Go to <strong>System &gt; Access &gt; Users</strong>.</li>
                        <li>Edit your user (e.g. <code>root</code>) or create a dedicated API user.</li>
                        <li>Scroll down to <strong>API keys</strong> and click the <strong>(+)</strong> button.</li>
                        <li>A file (<code>apikey.txt</code>) will download. Open it.</li>
                        <li>Copy the <strong>key</strong> and <strong>secret</strong> into the fields below.</li>
                    </ol>
                </div>

                <!-- ClearPass Manual Guide -->
                <div id="section-clearpass-guide" class="dynamic-section" style="display: none; margin-bottom: 1rem; border: 1px solid var(--accent-primary); padding: 1rem; border-radius: 0.5rem; background: rgba(45, 212, 191, 0.05);">
                    <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-primary);">â„¹ï¸ How to get ClearPass Credentials</div>
                    <ol style="font-size: 0.85rem; margin-left: 1.5rem; color: var(--text-secondary); line-height: 1.5;">
                        <li>Log in to <strong>ClearPass Guest</strong>.</li>
                        <li>Go to <strong>Administration &gt; API Services &gt; API Clients</strong>.</li>
                        <li>Create Client: Grant Type = <strong>Client credentials</strong>.</li>
                        <li>Profile: <strong>Super Administrator</strong> (or Cert Read/Write).</li>
                        <li>Copy <strong>Client ID</strong> and <strong>Client Secret</strong> below.</li>
                    </ol>
                </div>

                <!-- ClearPass Configuration -->
                <div id="section-clearpass-config" class="cyber-panel dynamic-section" style="display: none; margin-bottom: 1rem; padding: 1.5rem;">
                    <div style="font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">ClearPass Configuration</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Client ID</label>
                            <input type="text" id="cp-client-id" value="${service ? service.client_id || '' : ''}">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Client Secret</label>
                            <input type="password" id="cp-client-secret" value="${service ? service.client_secret || '' : ''}">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Additional Nodes (Comma separated IPs/Hosts)</label>
                        <input type="text" id="cp-additional-nodes" value="${service ? service.additional_nodes || '' : ''}" placeholder="192.168.1.11, 192.168.1.12">
                    </div>
                    <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                         <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">PFX Password (Optional)</label>
                            <input type="password" id="cp-pfx-pass" value="${service ? service.pfx_password || '' : ''}" placeholder="Auto-generated if empty">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Callback Host (Optional)</label>
                            <input type="text" id="cp-cb-host" value="${service ? service.callback_host || '' : ''}" placeholder="IP of this server (if auto-detect fails)">
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">Certificate Usage</label>
                        <select id="cp-usage">
                            <option value="HTTPS" ${service && service.cert_usage === 'HTTPS' ? 'selected' : ''}>HTTPS (Legacy)</option>
                            <option value="HTTPS(RSA)" ${service && (!service.cert_usage || service.cert_usage === 'HTTPS(RSA)') ? 'selected' : ''}>HTTPS (RSA)</option>
                            <option value="HTTPS(ECC)" ${service && service.cert_usage === 'HTTPS(ECC)' ? 'selected' : ''}>HTTPS (ECC)</option>
                            <option value="RADIUS" ${service && service.cert_usage === 'RADIUS' ? 'selected' : ''}>RADIUS</option>
                            <option value="RadSec" ${service && service.cert_usage === 'RadSec' ? 'selected' : ''}>RadSec</option>
                            <option value="Database" ${service && service.cert_usage === 'Database' ? 'selected' : ''}>Database</option>
                        </select>
                    </div>
                </div>

                <!-- API Credentials Section -->
                <div id="section-api-creds" class="cyber-panel dynamic-section" style="display: none; margin-bottom: 1rem; padding: 1.5rem;">
                     <div style="font-weight: 600; margin-bottom: 1rem; color: var(--text-primary);">API Credentials</div>
                     <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem;" id="lbl-api-key">API Key</label>
                        <input type="text" id="conf-api-key" value="${service ? service.api_key || '' : ''}">
                     </div>
                     <div id="div-api-secret">
                        <label style="font-size: 0.85rem; margin-bottom: 0.25rem;">API Secret</label>
                        <input type="password" id="conf-api-secret" value="${service ? service.api_secret || '' : ''}">
                     </div>
                </div>
                
                <div class="upload-card" style="margin-bottom: 1rem;">
                    <label>Additional Config (JSON)</label>
                    <textarea id="svc-extra" rows="5" style="width: 100%; font-family: var(--font-mono);">${JSON.stringify(service || {}, null, 2)}</textarea>
                    <small class="hint">Edit specific fields like 'user', 'token_id', etc. here. 'name', 'host', and 'type' above override this JSON.</small>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-glass);">
                    ${isEdit ? '<button id="delete-svc-btn" class="btn btn-secondary" style="border-color: var(--status-error); color: var(--status-error);">Delete</button>' : ''}
                    <button id="save-svc-btn" class="btn btn-primary">Save</button>
                    <button id="cancel-svc-btn" class="btn btn-secondary">Cancel</button>
                </div>
                </form>
            `;
            return html;
        }

        manageServicesBtn.onclick = async () => {
            document.getElementById('service-modal-title').innerText = "Manage Services";
            document.getElementById('service-modal-footer').style.display = 'block'; // Show Close button

            // Fetch both services AND types roughly in parallel or sequential
            try {
                await fetchTypes(); // Ensure we have latest types
                const res = await secureFetch(`${API_BASE}/status`);
                const data = await res.json();
                currentServices = data.services;

                const modalBody = document.getElementById('service-modal-body');
                modalBody.onclick = (e) => {
                    const btn = e.target.closest('.edit-svc-btn');
                    if (btn) {
                        openServiceEditorModal(btn.dataset.name);
                    }
                };

                modalBody.innerHTML = renderServiceList(currentServices);
                serviceModal.classList.remove('hidden');

                // Attach Event Listeners (Add btn only, Edit is delegated)
                document.getElementById('add-service-btn').onclick = () => openServiceEditorModal(null);
                document.getElementById('add-service-btn').onclick = () => openServiceEditorModal(null);

            } catch (e) {
                showToast("Failed to load services", "error");
            }
        };

        async function populatePackSelect(currentValue) {
            const select = document.getElementById('config-cert-pack');
            if (!select) return;

            try {
                const res = await fetch(`${API_BASE}/certificates`);
                const data = await res.json();

                // Clear existing (except maybe the header if we wanted one, but innerHTML overwrite is cleaner here)
                // We'll filter out the 'default' item from the API usually, or just handle overlap.
                // NOTE: 'list_cert_packs' ALREADY returns a "Default (Root)" item with id="default".
                // So we shouldn't manually add 'option value=default' unless we want to force it.
                // Let's rely on the API data to avoid duplication, or check for it.

                select.innerHTML = '';

                if (data.packs && Array.isArray(data.packs)) {
                    data.packs.forEach(pack => {
                        const opt = document.createElement('option');
                        // Handle if pack is string (legacy) or object
                        if (typeof pack === 'string') {
                            opt.value = pack;
                            opt.innerText = pack;
                            if (pack === currentValue) opt.selected = true;
                        } else {
                            opt.value = pack.id;
                            opt.innerText = pack.name; // Display Name
                            if (pack.id === currentValue) opt.selected = true;
                        }
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error("Failed to fetch cert packs", e);
            }
        }

        async function openServiceEditorModal(serviceName) {

            if (Object.keys(serviceTypesMap).length === 0) {
                await fetchTypes();
                // Check again
                if (Object.keys(serviceTypesMap).length === 0) {
                    showToast("Error: Could not load Service Types. Check connection.", "error");
                    // Log to console UI
                    const logC = document.getElementById('log-console');
                    if (logC) logC.innerHTML += `<br><span style="color:red">Error: Failed to fetch /api/types. Cannot open editor safely.</span>`;
                    return; // Prevent opening to avoid wiping data
                }
            }

            const service = serviceName ? currentServices.find(s => s.name === serviceName) : null;
            const modalBody = document.getElementById('service-modal-body');
            document.getElementById('service-modal-title').innerText = service ? `Edit ${service.name}` : "Add Service";
            document.getElementById('service-modal-footer').style.display = 'none';

            modalBody.innerHTML = renderServiceForm(service);

            // Populate Dropdown
            populateTypeSelect(service ? service.type : null);
            populatePackSelect(service ? service.cert_pack_id : 'default');

            // --- BIND EVENT LISTENERS (Dynamic Elements) ---

            // 1. Cancel
            document.getElementById('cancel-svc-btn').onclick = () => manageServicesBtn.click(); // Reload list

            // 2. Save
            document.getElementById('save-svc-btn').onclick = async () => {
                const name = document.getElementById('svc-name').value;
                const host = document.getElementById('svc-host').value;
                const type = document.getElementById('svc-type').value;
                const certPack = document.getElementById('config-cert-pack') ? document.getElementById('config-cert-pack').value : 'default';

                let extra = {};
                try {
                    extra = JSON.parse(document.getElementById('svc-extra').value);
                } catch (e) {
                    showToast("Invalid JSON in Additional Config", "error");
                    return;
                }

                let payload = { ...extra, name, host, type, cert_pack_id: certPack };

                // SSH/Linux/Portainer/Syncthing/OMV/Wazuh
                if (['linux', 'portainer', 'syncthing', 'omv', 'wazuh'].includes(type)) {
                    const u = document.getElementById('ssh-user'); if (u) payload.user = u.value;
                    const p = document.getElementById('ssh-pass'); if (p) payload.password = p.value;
                    const c = document.getElementById('ssh-cert-path'); if (c) payload.remote_cert_path = c.value;
                    const cmd = document.getElementById('ssh-cmd'); if (cmd) payload.restart_cmd = cmd.value;

                    if (type !== 'syncthing') {
                        const k = document.getElementById('ssh-key-path'); if (k) payload.remote_key_path = k.value;
                    }
                }

                if (type === 'webhook') {
                    const url = document.getElementById('webhook-url'); if (url) payload.url = url.value;
                    const m = document.getElementById('webhook-method'); if (m) payload.method = m.value;
                    const h = document.getElementById('webhook-headers');
                    if (h) {
                        try { payload.headers = JSON.parse(h.value); } catch (e) { payload.headers = h.value; }
                    }
                    const b = document.getElementById('webhook-body'); if (b) payload.body_template = b.value;
                }

                // API Creds
                if (['opnsense', 'truenas'].includes(type)) {
                    const k = document.getElementById('conf-api-key'); if (k) payload.api_key = k.value;
                    const s = document.getElementById('conf-api-secret'); if (s) payload.api_secret = s.value;
                }

                // ClearPass
                if (type === 'clearpass') {
                    const cid = document.getElementById('cp-client-id'); if (cid) payload.client_id = cid.value;
                    const csec = document.getElementById('cp-client-secret'); if (csec) payload.client_secret = csec.value;
                    const cppp = document.getElementById('cp-pfx-pass'); if (cppp) payload.pfx_password = cppp.value;
                    const cpcbh = document.getElementById('cp-cb-host'); if (cpcbh) payload.callback_host = cpcbh.value;
                    const cpusg = document.getElementById('cp-usage'); if (cpusg) payload.cert_usage = cpusg.value;
                    const cpan = document.getElementById('cp-additional-nodes'); if (cpan) payload.additional_nodes = cpan.value;
                }

                if (service) payload.original_name = service.name;

                const endpoint = service ? '/services/update' : '/services/add';
                try {
                    const res = await secureFetch(`${API_BASE}${endpoint}`, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.success) {
                        showToast("Service saved successfully", "success");
                        fetchStatus(); // Update main grid
                        manageServicesBtn.click(); // Back to list
                    } else {
                        showToast("Error: " + data.message, "error");
                    }
                } catch (e) {
                    showToast("Save Failed: Network Error", "error");
                }
            };

            // 3. Delete
            const delBtn = document.getElementById('delete-svc-btn');
            if (delBtn) {
                delBtn.onclick = async () => {
                    if (!await showConfirm("Delete Service", `Are you sure you want to delete ${service.name}?`, "Delete")) return;
                    try {
                        const res = await secureFetch(`${API_BASE}/services/delete`, {
                            method: 'POST',
                            body: JSON.stringify({ name: service.name })
                        });
                        const data = await res.json();
                        if (data.success) {
                            showToast("Service deleted", "success");
                            fetchStatus(); // Update main grid
                            manageServicesBtn.click();
                        } else {
                            showToast("Error: " + data.message, "error");
                        }
                    } catch (e) {
                        showToast("Delete Failed: Network Error", "error");
                    }
                };
            }

            // 4. Provisioning
            const provBtn = document.getElementById('prov-btn');
            if (provBtn) {
                provBtn.onclick = async () => {
                    const user = document.getElementById('prov-user').value;
                    const pass = document.getElementById('prov-pass').value;
                    const host = document.getElementById('svc-host').value;
                    const type = document.getElementById('svc-type').value; // Dynamic Type
                    const statusDiv = document.getElementById('prov-status');

                    if (!user || !pass || !host) {
                        statusDiv.innerHTML = '<span class="error-text">Host, User, and Password required.</span>';
                        showToast("Host, User, and Password required.", "error");
                        return;
                    }

                    statusDiv.innerHTML = `<span class="processing-text">Connecting to ${type}...</span>`;
                    provBtn.disabled = true;

                    try {
                        const payload = { type, host, user, password: pass };
                        const req = await secureFetch(`${API_BASE}/provision`, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        const res = await req.json();

                        if (res.success) {
                            statusDiv.innerHTML = `<span class="success-text">${res.message}</span>`;
                            showToast("Provisioning successful!", "success");

                            // Merge into JSON
                            let current = {};
                            try { current = JSON.parse(document.getElementById('svc-extra').value); } catch (e) { }

                            current.user = user; // Save user for reference

                            // Handle different cred types
                            if (res.credentials.token_id) {
                                current.token_id = res.credentials.token_id;
                                current.token_secret = res.credentials.token_secret;
                                showToast("Credentials auto-filled (Proxmox Token)", "success");
                            }
                            if (res.credentials.api_key) {
                                current.api_key = res.credentials.api_key;
                                // Auto-fill generic API Key input
                                const apiKeyInput = document.getElementById('conf-api-key');
                                if (apiKeyInput) { apiKeyInput.value = res.credentials.api_key; apiKeyInput.style.borderColor = 'var(--success-color)'; }
                                if (type === 'truenas') showToast("Credentials auto-filled (TrueNAS API Key)", "success");
                            }
                            if (res.credentials.api_secret) {
                                current.api_secret = res.credentials.api_secret;
                                // Auto-fill API Secret input
                                const apiSecretInput = document.getElementById('conf-api-secret');
                                if (apiSecretInput) { apiSecretInput.value = res.credentials.api_secret; apiSecretInput.style.borderColor = 'var(--success-color)'; }
                                if (type === 'opnsense') showToast("Credentials auto-filled (OPNsense Keys)", "success");
                            }
                            if (res.credentials.access_token) {
                                current.access_token = res.credentials.access_token;
                                showToast("Credentials auto-filled (Portainer Token)", "success");
                            }
                            if (res.credentials.node) current.node = res.credentials.node;

                            document.getElementById('svc-extra').value = JSON.stringify(current, null, 2);
                            // Also trigger updateJson to save these into the JSON blob immediately
                            if (typeof updateJson === 'function') updateJson();
                        } else {
                            statusDiv.innerHTML = `<span class="error-text">Error: ${res.message}</span>`;
                            showToast("Provisioning Failed: " + res.message, "error");
                        }
                    } catch (e) {
                        statusDiv.innerHTML = '<span class="error-text">Network Error</span>';
                        showToast("Provisioning Failed: Network Error", "error");
                    }
                    provBtn.disabled = false;
                };
            }
            document.getElementById('manage-types-btn').onclick = () => renderTypesManager();

            // Visibility Logic (Revised for Aliases)
            const updateVisibility = (alias) => {
                // Get Base Type
                const type = serviceTypesMap[alias] || alias;

                // SSH Section
                const sshSec = document.getElementById('section-linux');
                // Show SSH for Linux, Portainer, Syncthing, OMV, and Wazuh
                if (sshSec) sshSec.style.display = (['linux', 'portainer', 'syncthing', 'omv', 'wazuh'].includes(type) && type !== 'webhook') ? 'block' : 'none';

                // Webhook Section
                const webhookSec = document.getElementById('section-webhook');
                if (webhookSec) webhookSec.style.display = (type === 'webhook') ? 'block' : 'none';

                // Syncthing & OMV specifics
                const certLbl = document.getElementById('lbl-ssh-cert');
                const keyDiv = document.getElementById('ssh-key-path').parentNode;
                const certDiv = document.getElementById('ssh-cert-path').parentNode;
                const cmdDiv = document.getElementById('ssh-cmd').parentNode;

                if (type === 'syncthing') {
                    if (certLbl) certLbl.innerText = "Config Directory (Folder path)";
                    if (keyDiv) keyDiv.style.display = 'none';
                    if (certDiv) certDiv.style.display = 'block';
                    if (cmdDiv) cmdDiv.style.display = 'block';
                } else if (type === 'omv') {
                    // OMV: Hide Cert Path, Key Path, Cmd (All auto-handled)
                    if (keyDiv) keyDiv.style.display = 'none';
                    if (certDiv) certDiv.style.display = 'none';
                    if (cmdDiv) cmdDiv.style.display = 'none';
                } else {
                    if (certLbl) certLbl.innerText = "Remote Cert Path";
                    if (keyDiv) keyDiv.style.display = 'block';
                    if (certDiv) certDiv.style.display = 'block';
                    if (cmdDiv) cmdDiv.style.display = 'block';
                }

                const provSec = document.getElementById('section-provision');
                if (provSec) provSec.style.display = (['proxmox', 'truenas', 'portainer'].includes(type)) ? 'block' : 'none';

                // OPNsense Guide
                const opnSec = document.getElementById('section-opnsense-guide');
                if (opnSec) opnSec.style.display = (type === 'opnsense') ? 'block' : 'none';

                const provUser = document.getElementById('prov-user');
                if (provUser) {
                    if (type === 'proxmox') provUser.placeholder = 'root@pam';
                    if (type === 'truenas') provUser.placeholder = 'root (Basic Auth)';
                    if (type === 'portainer') provUser.placeholder = 'admin';
                }

                // ClearPass Visibility
                const cpGuide = document.getElementById('section-clearpass-guide');
                const cpConfig = document.getElementById('section-clearpass-config');
                if (cpGuide) cpGuide.style.display = (type === 'clearpass') ? 'block' : 'none';
                if (cpConfig) cpConfig.style.display = (type === 'clearpass') ? 'block' : 'none';

                // API Creds Section
                const apiSec = document.getElementById('section-api-creds');
                if (apiSec) {
                    apiSec.style.display = (['opnsense', 'truenas'].includes(type)) ? 'block' : 'none';

                    // Secret is optional for TrueNAS (it just needs api_key usually)
                    // But actually TrueNAS uses just api_key. OPNsense uses key+secret.
                    const secretDiv = document.getElementById('div-api-secret');
                    if (secretDiv) secretDiv.style.display = (type === 'opnsense') ? 'block' : 'none';
                }
            };

            // Live JSON Sync
            let updateJson = () => {
                const name = document.getElementById('svc-name').value;
                const host = document.getElementById('svc-host').value;
                const alias = document.getElementById('svc-type').value;
                const type = serviceTypesMap[alias] || alias; // Base Type

                // We use the textarea as the base for 'extra' fields not in UI
                let current = {};
                try { current = JSON.parse(document.getElementById('svc-extra').value); } catch (e) { }

                // UI Fields override the object for internal tracking (if we kept state)
                // But here we want to update the DISPLAY (textarea)
                // So we put UI values into the object, MASKED if sensitive.

                // Note: We can't put masked values into 'current' if we verify valid JSON structure? 
                // Any edit to the JSON box manually will wipe the mask if we aren't careful.
                // But the user edits the JSON box for "Config (JSON)".

                // Strategy: The JSON box will store "********" for secrets.
                // The SAVE button will ignore the JSON box value for secrets and read from inputs.

                current.name = name;
                current.host = host;
                current.type = alias; // Save Alias

                // SSH/Linux/Portainer/Syncthing/OMV/Wazuh
                if (['linux', 'portainer', 'syncthing', 'omv', 'wazuh'].includes(type) && type !== 'webhook') {
                    if (document.getElementById('ssh-user')) current.user = document.getElementById('ssh-user').value;
                    if (document.getElementById('ssh-pass')) current.password = "********"; // MASKED

                    if (type !== 'omv') {
                        if (document.getElementById('ssh-cert-path')) current.remote_cert_path = document.getElementById('ssh-cert-path').value;
                    }

                    if (!['syncthing', 'omv'].includes(type)) {
                        if (document.getElementById('ssh-key-path')) current.remote_key_path = document.getElementById('ssh-key-path').value;
                    } else {
                        delete current.remote_key_path; // Syncthing/OMV infers key path
                    }

                    if (type !== 'omv' && document.getElementById('ssh-cmd')) current.restart_cmd = document.getElementById('ssh-cmd').value;
                    // OMV handles restart internally usually, but we could allow override later. 
                    // For now, hide restart_cmd for OMV to keep it simple as per "Zero Config" goal.
                }

                // Webhook Fields
                if (type === 'webhook') {
                    if (document.getElementById('webhook-url')) current.url = document.getElementById('webhook-url').value;
                    if (document.getElementById('webhook-method')) current.method = document.getElementById('webhook-method').value;

                    // Headers (Try Parse or leave as string for backend to handle/reject?)
                    // Let's store as string in the textarea for display, but object in JSON? 
                    // No, the UI textarea is the source of truth here.
                    // But we want 'current' to be the object that gets saved.
                    // Actually, if we just save the string, we might double encode.
                    // Let's try to parse it.
                    let hVal = document.getElementById('webhook-headers').value;
                    try { current.headers = JSON.parse(hVal); } catch (e) { current.headers = hVal; } // Fallback to string if invalid

                    if (document.getElementById('webhook-body')) current.body_template = document.getElementById('webhook-body').value;
                }

                // API Creds
                if (['opnsense', 'truenas'].includes(type)) {
                    if (document.getElementById('conf-api-key')) current.api_key = document.getElementById('conf-api-key').value;
                    if (document.getElementById('conf-api-secret')) current.api_secret = "********"; // MASKED
                }

                document.getElementById('svc-extra').value = JSON.stringify(current, null, 2);
                updateVisibility(alias);
            };

            // Re-bind listeners because we redefined the variable
            document.getElementById('svc-name').oninput = updateJson;
            document.getElementById('svc-host').oninput = updateJson;
            // Smart Type Change Handler
            document.getElementById('svc-type').onchange = () => {
                const alias = document.getElementById('svc-type').value;
                const type = serviceTypesMap[alias] || alias;

                const cmdInput = document.getElementById('ssh-cmd');
                const hostInput = document.getElementById('svc-host');

                // Smart Restart Command Default
                if (cmdInput) {
                    if (type === 'syncthing') {
                        // If it's the generic default, switch to Syncthing default
                        if (cmdInput.value === 'systemctl reload nginx' || cmdInput.value === 'docker restart portainer') {
                            cmdInput.value = 'docker restart syncthing';
                        }
                    } else if (['linux'].includes(type)) {
                        // If it's a known default of another type, switch to generic default
                        if (['docker restart syncthing', 'docker restart portainer'].includes(cmdInput.value)) {
                            cmdInput.value = 'systemctl reload nginx';
                        }
                    } else if (type === 'portainer') {
                        if (cmdInput.value === 'systemctl reload nginx') {
                            cmdInput.value = 'docker restart portainer';
                        }
                    } else if (type === 'wazuh') {
                        if (cmdInput.value === 'systemctl reload nginx' || cmdInput.value === 'docker restart portainer') {
                            cmdInput.value = 'systemctl restart wazuh-dashboard';
                        }

                        const certInput = document.getElementById('ssh-cert-path');
                        const keyInput = document.getElementById('ssh-key-path');

                        if (certInput && (certInput.value === '/etc/ssl/certs/fullchain.pem' || certInput.value === '')) {
                            certInput.value = '/etc/wazuh-dashboard/certs/fullchain.pem';
                        }
                        if (keyInput && (keyInput.value === '/etc/ssl/private/privkey.pem' || keyInput.value === '')) {
                            keyInput.value = '/etc/wazuh-dashboard/certs/privkey.pem';
                        }
                    }
                }

                updateJson();
            };

            // Initial Init
            updateVisibility(service ? service.type : (document.getElementById('svc-type').value || 'proxmox'));
            if (service) updateJson();

            // Re-attach listeners to SSH fields if they exist (they might be hidden but exist)
            ['ssh-user', 'ssh-pass', 'ssh-cert-path', 'ssh-key-path', 'ssh-cmd'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.oninput = updateJson;
            });

            ['webhook-url', 'webhook-method', 'webhook-headers', 'webhook-body'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.oninput = updateJson;
            });

            ['conf-api-key', 'conf-api-secret'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.oninput = updateJson;
            });

            // ClearPass Inputs
            ['cp-client-id', 'cp-client-secret', 'cp-pfx-pass', 'cp-cb-host', 'cp-usage', 'cp-additional-nodes'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.oninput = updateJson;
            });

            // Initial call to set visibility and JSON
            updateJson();

            // Show Modal
            const serviceModal = document.getElementById('service-modal');
            serviceModal.classList.remove('hidden');


            // SSH Detection Logic
            const sshDetectBtn = document.getElementById('ssh-detect-btn');
            if (sshDetectBtn) {
                sshDetectBtn.onclick = async () => {
                    const originalText = sshDetectBtn.innerHTML;
                    const user = document.getElementById('ssh-user').value;
                    const pass = document.getElementById('ssh-pass').value;
                    const host = document.getElementById('svc-host').value;
                    const type = document.getElementById('svc-type').value; // Original ID

                    if (type !== 'portainer') {
                        showToast("Auto-detection currently only supported for Portainer.", "warning");
                        return;
                    }

                    sshDetectBtn.textContent = "Detecting...";
                    sshDetectBtn.disabled = true;

                    try {
                        const res = await secureFetch(`${API_BASE}/detect-paths`, {
                            method: 'POST',
                            body: JSON.stringify({ type, host, user, password: pass })
                        });
                        const data = await res.json();

                        if (data.success) {
                            if (data.paths.remote_cert_path) {
                                document.getElementById('ssh-cert-path').value = data.paths.remote_cert_path;
                                document.getElementById('ssh-cert-path').style.borderColor = 'var(--success-color)';
                            }
                            if (data.paths.remote_key_path) {
                                document.getElementById('ssh-key-path').value = data.paths.remote_key_path;
                                document.getElementById('ssh-key-path').style.borderColor = 'var(--success-color)';
                            }
                            if (data.paths.restart_cmd) {
                                document.getElementById('ssh-cmd').value = data.paths.restart_cmd;
                                document.getElementById('ssh-cmd').style.borderColor = 'var(--success-color)';
                            }
                            updateJson();
                            showToast("Paths detected and updated!", "success");
                        } else {
                            showToast("Detection Failed: " + res.message, "error");
                        }
                    } catch (e) {
                        sshDetectBtn.disabled = false;
                        sshDetectBtn.innerHTML = originalText;
                        showToast("Detection Error: " + e, "error");
                    }
                };
            }

            // Moved listeners inside openServiceEditorModal to ensure binding on fresh DOM
        }

        // Close modal handlers
        document.querySelectorAll('.close-modal').forEach(btn => btn.onclick = () => serviceModal.classList.add('hidden'));
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => serviceModal.classList.add('hidden'));

        // Upload Logic
        uploadBtn.onclick = async () => {
            const certFile = document.getElementById('file-cert').files[0];
            const keyFile = document.getElementById('file-key').files[0];
            const interFile = document.getElementById('file-inter').files[0];
            const rootFile = document.getElementById('file-root').files[0];

            if (!certFile || !keyFile) {
                uploadStatus.innerHTML = '<span class="error-text">Certificate and Private Key are required.</span>';
                return;
            }

            const formData = new FormData();
            formData.append('cert', certFile);
            formData.append('key', keyFile);
            if (interFile) formData.append('inter', interFile);
            if (rootFile) formData.append('root', rootFile);

            uploadStatus.innerHTML = '<span class="processing-text">Validating...</span>';
            uploadBtn.disabled = true;

            try {
                const res = await secureFetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    uploadStatus.innerHTML = '<span class="success-text">Success!</span>';
                    // Pass true to hide log console (treat as inspection details view)
                    showModal(data.details, true);
                    fetchStatus();
                } else {
                    uploadStatus.innerHTML = `<span class="error-text">${data.message}</span>`;
                }
            } catch (e) {
                uploadStatus.innerHTML = '<span class="error-text">Network Error</span>';
            }
            uploadBtn.disabled = false;
        };

        // Modal Logic
        function showModal(details, is_inspection = false) {
            let html = '';

            // Determine Status for Theme
            const modalDrawer = document.querySelector('#cert-modal .modal-drawer');
            modalDrawer.classList.remove('modal-theme-success', 'modal-theme-error', 'modal-theme-warning');

            let isSuccess = true;
            if (is_inspection) {
                if (!details.key_match) isSuccess = false;
                // Check if any cert in chain is expired
                if (details.details && Array.isArray(details.details)) {
                    if (details.details.some(c => c.days_remaining < 0)) isSuccess = false;
                }
            } else {
                // Single cert check
                if (details.days_remaining < 0) isSuccess = false;
            }

            if (isSuccess) modalDrawer.classList.add('modal-theme-success');
            else modalDrawer.classList.add('modal-theme-error');


            if (is_inspection) {
                const matchClass = details.key_match ? 'success-text' : 'error-text';
                const matchText = details.key_match ? 'MATCHED' : 'INVALID/MISMATCH';
                html += `
                    <div class="detail-row"><strong>Chain Length:</strong> ${details.chain_length} Certificate(s)</div>
                    <div class="detail-row"><strong>Key Pair Status:</strong> <span class="${matchClass}">${matchText}</span></div>
                    <hr style="border: 0; border-top: 1px solid var(--card-border); margin: 1rem 0;">
                `;
                // If inspecting, details.details is an array of certs
                if (details.details && Array.isArray(details.details)) {
                    details.details.forEach((cert, idx) => {
                        const title = idx === 0 ? "Leaf Certificate" : (idx === details.details.length - 1 ? "Root Certificate" : "Intermediate Certificate");
                        html += `
                            <h4 style="color: var(--accent-color); margin: 1rem 0 0.5rem 0;">${title} (${idx + 1}/${details.details.length})</h4>
                            <div class="detail-row"><strong>Subject:</strong> ${cert.subject}</div>
                            <div class="detail-row"><strong>Issuer:</strong> ${cert.issuer}</div>
                            <div class="detail-row"><strong>Serial:</strong> ${cert.serial_number}</div>
                            <div class="detail-row"><strong>Algorithm:</strong> ${cert.signature_algorithm}</div>
                            <div class="detail-row"><strong>Expires:</strong> ${cert.expiry}</div>
                            <div class="detail-row"><strong>Days Remaining:</strong> ${cert.days_remaining}</div>
                            <div class="detail-row"><strong>SANs:</strong> ${cert.sans ? cert.sans.join(', ') : 'None'}</div>
                            ${idx < details.details.length - 1 ? '<hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 1rem 0;">' : ''}
                        `;
                    });
                }
            } else {
                // Single cert upload
                html += `
                    <div class="detail-row"><strong>Subject:</strong> ${details.subject}</div>
                    <div class="detail-row"><strong>Issuer:</strong> ${details.issuer}</div>
                    <div class="detail-row"><strong>Serial:</strong> ${details.serial_number}</div>
                    <div class="detail-row"><strong>Algorithm:</strong> ${details.signature_algorithm}</div>
                    <div class="detail-row"><strong>Expires:</strong> ${details.expiry}</div>
                    <div class="detail-row"><strong>Days Remaining:</strong> ${details.days_remaining}</div>
                    <div class="detail-row"><strong>SANs:</strong> ${details.sans ? details.sans.join(', ') : 'None'}</div>
                `;
            }

            // Toggle Logs
            const logs = document.getElementById('modal-log-console');
            if (is_inspection) {
                logs.style.display = 'none';
            } else {
                logs.style.display = 'block';
            }

            modalBody.innerHTML = html;
            modal.classList.remove('hidden');
        }

        viewCertBtn.onclick = async () => {
            viewCertBtn.disabled = true;
            viewCertBtn.innerText = "Fetch...";
            try {
                const res = await secureFetch(`${API_BASE}/cert/inspect`);
                if (res.status === 401) {
                    showToast("System Locked. Please log in again.", "warning");
                    window.location.href = '/login';
                    return;
                }
                const data = await res.json();
                if (data.found) {
                    const fullDetails = {
                        chain_length: data.chain_length,
                        key_match: data.key_match,
                        details: data.details
                    };
                    showModal(fullDetails, true);
                } else {
                    showToast(data.message || "No certificate found on server.", "warning");
                }
            } catch (e) {
                showToast("Error fetching certificate details", "error");
            }
            viewCertBtn.disabled = false;
            viewCertBtn.innerText = "View Default Certificate";
        };

        // Cert Modal Close
        closeSpans.forEach(btn => btn.onclick = () => modal.classList.add('hidden'));

        // Service Modal Close (Explicit Handlers)
        document.querySelector('#service-modal .close-modal').onclick = () => serviceModal.classList.add('hidden');
        document.querySelector('#service-modal .close-modal-btn').onclick = () => serviceModal.classList.add('hidden');

        // Close on click outside
        window.onclick = (e) => {
            if (e.target == modal) modal.classList.add('hidden');
            if (e.target == serviceModal) serviceModal.classList.add('hidden');
        };

        // Show Action Modal (Custom Content)
        function showActionModal(title, bodyHtml, buttonsHtml = "") {
            actionTitle.innerText = title;
            actionBody.innerHTML = bodyHtml;

            // Allow injecting extra buttons before the Close button
            const closeBtnHtml = '<button class="secondary-btn close-modal-action-btn">Close</button>';
            actionFooter.innerHTML = buttonsHtml + closeBtnHtml;

            // Re-bind close button since we overwrote innerHTML
            const closeBtn = actionFooter.querySelector('.close-modal-action-btn');
            if (closeBtn) closeBtn.onclick = hideActionModal;

            actionModal.classList.remove('hidden');
        }



        async function cleanupService(serviceName) {
            if (!await showConfirm("Delete Expired Certs", "Are you sure you want to delete expired 'AutoRenew' certificates? This cannot be undone.", "Delete All")) return;

            try {
                const req = await secureFetch(`${API_BASE}/cleanup/${serviceName}`, { method: 'POST' });
                const res = await req.json();
                if (res.success) {
                    showToast(res.message, "success");
                    hideActionModal();
                    // Optionally refresh status if needed
                    fetchStatus();
                } else {
                    showToast("Cleanup Failed: " + res.message, "error");
                }
            } catch (e) {
                showToast("Error: " + e, "error");
            }
        }

        // Missing Helper for Edit Button
        function openServiceEditor(name) {
            const svc = currentServices.find(s => s.name === name);
            if (!svc) return showToast("Service not found in local cache", "error");

            // Populate form
            renderServiceForm(svc);

            // Bind Type Manager
            setTimeout(() => {
                const btn = document.getElementById('manage-types-btn');
                if (btn) btn.onclick = renderTypesManager;
            }, 50);

            // Populate Packs
            populatePackSelect(svc.cert_pack_id || 'default');

            // Show Modal
            const serviceModal = document.getElementById('service-modal');
            serviceModal.classList.remove('hidden');
        }

        // --- Certificate Pack Manager ---
        async function openCertManager() {
            // 1. Fetch Packs
            let packs = [];
            try {
                const res = await secureFetch(`${API_BASE}/certificates`);
                const data = await res.json();
                packs = data.packs || [];
            } catch (e) {
                console.error("Fetch packs failed:", e);
                return;
            }

            const modal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('details-modal-title');
            const modalBody = document.getElementById('details-modal-body');

            modalTitle.textContent = "Certificate Manager";

            // Build UI
            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1rem;">Available Certificate Packs</h3>
                    <div style="max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 0.5rem; border: 1px solid var(--card-border);">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 25%;">
                                <col style="width: 30%;">
                                <col>
                                <col style="width: 80px;">
                            </colgroup>
                            <thead style="background: rgba(255,255,255,0.05); color: var(--text-secondary); text-align: left;">
                                <tr>
                                    <th style="padding: 0.75rem;">Name</th>
                                    <th style="padding: 0.75rem;">Expiry</th>
                                    <th style="padding: 0.75rem;">Path</th>
                                    <th style="padding: 0.75rem; text-align: center;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${packs.map(p => {
                let expiryDisplay = '<span style="color: var(--text-secondary);">Unknown</span>';
                if (p.expiry) {
                    const date = new Date(p.expiry).toLocaleDateString();
                    const days = p.days_remaining;
                    let color = 'var(--text-primary)';
                    if (days < 0) color = 'var(--status-error)';
                    else if (days < 30) color = 'var(--status-warning)';
                    else color = 'var(--status-success)';

                    expiryDisplay = `<div style="color: ${color}; font-weight: 500; font-size: 0.85rem; line-height: 1.2;">${date}<br><span style="font-size: 0.75rem; opacity: 0.8;">(${days}d)</span></div>`;
                }

                return `
                                    <tr style="border-bottom: 1px solid var(--card-border);">
                                        <td style="padding: 0.75rem; word-break: break-all; vertical-align: middle;">${p.name}</td>
                                        <td style="padding: 0.75rem; vertical-align: middle;">${expiryDisplay}</td>
                                        <td style="padding: 0.75rem; color: var(--text-secondary); font-family: monospace; overflow-wrap: break-word; word-break: break-all; font-size: 0.75rem; vertical-align: middle; line-height: 1.4;">${p.path}</td>
                                        <td style="padding: 0.75rem; vertical-align: middle;">
                                            <div style="display: flex; gap: 0.6rem; justify-content: center; align-items: center;">
                                                <button class="cyber-icon-btn check" onclick="inspectPack('${p.id}')" title="Inspect Details">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                        <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
                                                        <circle cx="12" cy="12" r="3" stroke-dasharray="2 3"/>
                                                        <path d="M12 9v6M9 12h6" stroke-opacity="0.4"/>
                                                    </svg>
                                                </button>
                                                ${p.id !== 'default' ?
                        `<button class="cyber-icon-btn delete" onclick="deletePack('${p.id}')" title="Delete Pack">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>
                                                    </svg>
                                                </button>`
                        : '<span style="color:var(--text-secondary); font-size:0.65rem; opacity: 0.6; white-space: nowrap;">LOCKED</span>'}
                                            </div>
                                        </td>
                                    </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="border-top: 1px solid var(--card-border); padding-top: 1.5rem;">
                    <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1rem;">Upload New Pack</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Pack Name</label>
                            <input type="text" id="new-pack-name" placeholder="e.g. staging-cert" style="width: 100%; padding: 0.6rem; background: rgba(0,0,0,0.2); border: 1px solid var(--card-border); border-radius: 0.3rem; color: var(--text-primary); font-family: var(--font-primary);">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Leaf Cert -->
                            <div>
                                <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Leaf Certificate</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="new-pack-cert" class="cyber-file-input" onchange="updateFileName(this, 'display-pack-cert')">
                                    <label for="new-pack-cert" class="cyber-file-label">CHOOSE FILE</label>
                                    <span id="display-pack-cert" class="file-name-display">NO_FILE_CHOSEN</span>
                                </div>
                            </div>
                            <!-- Private Key -->
                            <div>
                                <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Private Key</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="new-pack-key" class="cyber-file-input" onchange="updateFileName(this, 'display-pack-key')">
                                    <label for="new-pack-key" class="cyber-file-label">CHOOSE FILE</label>
                                    <span id="display-pack-key" class="file-name-display">NO_FILE_CHOSEN</span>
                                </div>
                            </div>
                            <!-- Intermediate -->
                            <div>
                                <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Intermediate CA (Optional)</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="new-pack-inter" class="cyber-file-input" onchange="updateFileName(this, 'display-pack-inter')">
                                    <label for="new-pack-inter" class="cyber-file-label">CHOOSE FILE</label>
                                    <span id="display-pack-inter" class="file-name-display">NO_FILE_CHOSEN</span>
                                </div>
                            </div>
                            <!-- Root CA -->
                            <div>
                                <label style="display: block; font-size: 0.8rem; margin-bottom: 0.4rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Root CA (Optional)</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="new-pack-root" class="cyber-file-input" onchange="updateFileName(this, 'display-pack-root')">
                                    <label for="new-pack-root" class="cyber-file-label">CHOOSE FILE</label>
                                    <span id="display-pack-root" class="file-name-display">NO_FILE_CHOSEN</span>
                                </div>
                            </div>
                        </div>
                        <button id="upload-pack-btn" class="btn btn-primary" style="justify-self: start; margin-top: 0.5rem;">Upload Pack</button>
                    </div>
                    <div id="pack-upload-status" style="margin-top: 0.8rem; font-size: 0.9rem;"></div>
                </div>
            `;

            modalBody.innerHTML = html;
            modal.classList.remove('hidden');

            // Bind Upload
            document.getElementById('upload-pack-btn').onclick = async () => {
                const name = document.getElementById('new-pack-name').value;
                const cert = document.getElementById('new-pack-cert').files[0];
                const key = document.getElementById('new-pack-key').files[0];
                const inter = document.getElementById('new-pack-inter').files[0];
                const root = document.getElementById('new-pack-root').files[0];
                const status = document.getElementById('pack-upload-status');

                if (!name || !cert || !key) {
                    status.innerHTML = `<span style="color: var(--error-color);">Name, Leaf Cert, and Key are required.</span>`;
                    return;
                }

                status.innerHTML = `<span style="color: var(--accent-color);">Uploading...</span>`;

                const formData = new FormData();
                formData.append('name', name);
                formData.append('cert_file', cert);
                formData.append('key_file', key);
                if (inter) formData.append('inter_file', inter);
                if (root) formData.append('root_file', root);

                try {
                    const res = await secureFetch(`${API_BASE}/certificates/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        status.innerHTML = `<span style="color: var(--success-color);">Success! Pack saved. Re-open to see list.</span>`;
                        // Reload list? For now just static success message.
                    } else {
                        status.innerHTML = `<span style="color: var(--error-color);">Error: ${data.message}</span>`;
                    }
                } catch (e) {
                    status.innerHTML = `<span style="color: var(--error-color);">Upload failed.</span>`;
                }
            };
        }

        // Global Delete Pack
        window.deletePack = async (name) => {
            if (!await showConfirm("Delete Certificate Pack", `Delete pack '${name}'? This cannot be undone.`, "Delete")) return;

            try {
                const res = await secureFetch(`${API_BASE}/certificates/${name}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    showToast("Pack deleted", "success");
                    // Refresh manager
                    openCertManager();
                } else {
                    showToast("Error: " + data.message, "error");
                }
            } catch (e) {
                showToast("Delete failed: " + e, "error");
            }
        };

        // Global Inspect Pack
        window.inspectPack = async (name) => {
            // Use 'default' if None/Empty, but API handles it via 'default' literal or empty, let's pass explicit
            const packParam = name === 'default' ? '' : name;

            try {
                const res = await secureFetch(`${API_BASE}/cert/inspect?pack=${packParam}`);
                const data = await res.json();

                if (data.found) {
                    const fullDetails = {
                        chain_length: data.chain_length,
                        key_match: data.key_match,
                        details: data.details
                    };
                    // Hack: Temporarily hide manager modal to show details? 
                    // Or reuse details modal? showModal uses 'cert-modal' which we haven't touched for a while or maybe we renamed it?
                    // showModal was using 'cert-modal'. Let's verify if showModal exists and what ID it opens.
                    // It uses 'details-modal' now? No, the recent edit added 'details-modal' for the Manager.
                    // 'showModal' logic (line 1357) likely opens... wait, I need to check showModal implementation.
                    showModal(fullDetails, true);
                } else {
                    showToast("Verification Failed: " + data.message, "error");
                }
            } catch (e) {
                showToast("Inspect failed: " + e, "error");
            }
        };

        // Settings Modal Logic
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsSpans = document.querySelectorAll('.close-modal-settings, .close-modal-settings-btn');

        if (settingsBtn) {
            settingsBtn.onclick = () => settingsModal.classList.remove('hidden');
        }

        closeSettingsSpans.forEach(span => {
            span.onclick = () => settingsModal.classList.add('hidden');
        });

        document.getElementById('logout-btn').onclick = () => {
            window.location.href = '/logout';
        };

        document.getElementById('change-pass-btn').onclick = async () => {
            const currentPass = document.getElementById('current-pass').value;
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;
            const btn = document.getElementById('change-pass-btn');

            if (!currentPass || !newPass) {
                showToast("Please fill in all fields.", "warning");
                return;
            }
            if (newPass !== confirmPass) {
                showToast("New passwords do not match.", "error");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Updating...";

            try {
                const res = await secureFetch('/api/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ current_password: currentPass, new_password: newPass })
                });
                const data = await res.json();

                if (data.success) {
                    showToast("Password updated successfully!", "success");
                    document.getElementById('current-pass').value = '';
                    document.getElementById('new-pass').value = '';
                    document.getElementById('confirm-pass').value = '';
                    settingsModal.classList.add('hidden');
                } else {
                    showToast("Failed: " + data.message, "error");
                }
            } catch (e) {
                showToast("Error: " + e, "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Update Password";
            }
        };

        // Close on click outside (Update to include actionModal)
        window.onclick = (e) => {
            if (e.target == modal) modal.classList.add('hidden');
            if (e.target == serviceModal) serviceModal.classList.add('hidden');
            if (e.target == actionModal) actionModal.classList.add('hidden');
            if (e.target == settingsModal) settingsModal.classList.add('hidden');
            const detailsModal = document.getElementById('details-modal');
            if (e.target == detailsModal) detailsModal.classList.add('hidden');
        };

        // Manual Close Bindings
        document.getElementById('close-details-modal').onclick = () => document.getElementById('details-modal').classList.add('hidden');
        document.getElementById('close-details-btn').onclick = () => document.getElementById('details-modal').classList.add('hidden');

        function updateTimers() {
            document.querySelectorAll('.live-timer').forEach(el => {
                const ts = el.getAttribute('data-ts');
                if (ts) {
                    el.innerText = timeAgo(ts);
                }
            });
        }
        setInterval(updateTimers, 10000); // Update every 10 seconds

        // Helper for Custom File Inputs
        function updateFileName(input, displayId) {
            const display = document.getElementById(displayId);
            if (input.files && input.files.length > 0) {
                display.textContent = input.files[0].name;
                display.style.color = 'var(--text-primary)';
            } else {
                display.textContent = 'NO_FILE_CHOSEN';
                display.style.color = 'var(--text-secondary)';
            }
        }

        // Expose critical functions to window for dynamic HTML onclicks
        window.renderTypesManager = renderTypesManager;
        window.openServiceEditor = openServiceEditor;
        window.updateFileName = updateFileName;

        init();
    </script>
</body>

</html>